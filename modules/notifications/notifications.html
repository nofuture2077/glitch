<script>
    let queue = [];
    let playing = false;
    let index = 0;
    let alertTemplates = {};
    const vars = ['text', 'user', 'amout'];

    fetch ('./alerts/alerts.json').then(res => res.json()).then((templates) => {
        alertTemplates = templates;
    }, () => {
        console.warn('Could not load alerts. Place them in public/alerts/');
    })
</script>
<div id="snackbar"></div>

<script>
    var textToSpeech = function(text) {
        return new Promise((resolve, fail) => {
            const url = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=GOOGLE_API_KEY'
            const data = {
            'input':{
                'text': text
            },
            'voice':{
                'languageCode':'de-de',
                'name':'de-DE-Wavenet-E',
                'ssmlGender':'MALE'
            },
            'audioConfig':{
                'audioEncoding':'MP3'
            }
            };
            const otherparam={
                headers:{
                    "content-type":"application/json; charset=UTF-8"
                },
                body:JSON.stringify(data),
                method:"POST"
            };
            return fetch(url, otherparam)
                .then(data=>{return data.json()})
                .then(res=>{resolve(res.audioContent); })
            .catch(fail)
        });
    };

    function type(i, t, ie, oe) {
        input = document.getElementById(ie).innerHTML;
        document.getElementById(oe).innerHTML += input.charAt(i);
        setTimeout(function(){
            ((i < input.length - 1) ? type(i+1, t, ie, oe) : false);
        }, t);
    }

    function showNotification(item) {
        playing = true;
        const alertTemplate = alertTemplates[item.type] || {
            html: '<div>New alert</div>',
            style: 'show'
        };

        var x = document.getElementById("snackbar");
        let html = vars.reduce((text, v) => text.replace('#{' + v + '}', item[v] || alertTemplate[v]), alertTemplate.html);
        let numMatches = html.match(/#{userhash-(\d+)-(\d)}/);

        if (numMatches) {
            let num = parseInt(numMatches[1], 10);
            let randomNum = hash(item.user) % num;
            
            let index = ("0000000000000000000" + randomNum).substr(-numMatches[2],numMatches[2]);

            html = html.replace(/#{userhash-\d+-\d}/g, index);
        }

        if (alertTemplate.tts && getSetting('tts_on') === 'on') {
            if (alertTemplate.audio) {
                new Audio(alertTemplate.audio).play();
            }
            const ttsMessage = vars.reduce((text, v) => { 
                return text.replace('#{' + v + '}', (v === "user" && alertTemplate.useralias) ? (alertTemplate.useralias[item[v]] || item[v]) : (item[v] || alertTemplate[v]));
            }, alertTemplate.tts);
            
            textToSpeech(ttsMessage).then(audioContent => {
                const audio = new Audio('data:audio/mp3;base64,' + audioContent);

                audio.onloadedmetadata = () => {
                    setInnerHTML(x, html);
                    x.className = alertTemplate.style;
                    let duration = Math.max(audio.duration, 3);
                    if (alertTemplate.typing) {
                        type(0, 50, "typetemplate", "typetarget");
                        duration = Math.max(duration, 7);
                    }
                    audio.play();
                    setTimeout(function () { x.className = x.className.replace(alertTemplate.style, "hide"); playing = false; }, duration * 1000);
                }
            });
        } else if (alertTemplate.audio) {
            const audio = new Audio(alertTemplate.audio);

            audio.onloadedmetadata = () => {
                setInnerHTML(x, html);
                x.className = alertTemplate.style;
                let duration = Math.max(audio.duration, 3);
                if (alertTemplate.typing) {
                    type(0, 50, "typetemplate", "typetarget");
                    duration = Math.max(duration, 7);
                }
                audio.play();
                setTimeout(function () { x.className = x.className.replace(alertTemplate.style, "hide"); playing = false; }, duration * 1000);
            }
        } else {
            setInnerHTML(x, html);
            x.className = alertTemplate.style;
            if (alertTemplate.typing) {
                type(0, 100, "typetemplate", "typetarget");
            }
            const duration = 3;
            setTimeout(function () { x.className = x.className.replace(alertTemplate.style, "hide"); playing = false; }, duration * 1000);
        }

    }

    function checkQueue() {
        if (playing) return;

        const queuelength = queue.length;

        if (queuelength - index > 3) {
            // skip follow bot
            index = queue.length;
        }
        if (index >= queue.length) return

        const item = queue[index++];

        if (!item) return;

        if (getSetting(item.type) === 'off') return;

        showNotification(item);
    }

    PubSub.subscribe('MSG!notifications', (msg, data) => {
        queue.push(data.data);
    });

    setInterval(checkQueue, 1000)
</script>

<style>
#snackbar {
  visibility: hidden;
  font-weight: bold;
  font-size: 24px;
  padding: 16px;
  position: fixed;
  z-index: 1;
  height: auto;
}

.top {
  left: 50%;
  top: 20px; 
  width: 300px;
  margin-left: -150px;
  text-align: center;
}

.left {
    top: 40%;
    max-width: 420px;
}

.info {
    color: #fff;
    background-color: rgb(var(--blue));
     box-shadow: 3px 3px 1px rgba(var(--blue), 0.6), 6px 6px 1px rgba(var(--blue), 0.3);
}

.new {
    color: #fff;
    background-color: rgb(var(--yellow));
    box-shadow: 3px 3px 1px rgba(var(--yellow), 0.6), 6px 6px 1px rgba(var(--yellow), 0.3);
}

.success {
    color: #fff;
     background-color: rgb(var(--green));
     box-shadow: 3px 3px 1px rgba(var(--green), 0.6), 6px 6px 1px rgba(var(--green), 0.3);
}

.failed {
    color: #fff;
    background-color: rgb(var(--red));
    box-shadow: 3px 3px 1px rgba(var(--red), 0.6), 6px 6px 1px rgba(var(--red), 0.3);
}

.neutral {
    color: #fff;
    background-color: rgba(var(--black), 0.6);
    box-shadow: 3px 3px 1px rgba(var(--black), 0.3), 6px 6px 1px rgba(var(--black), 0.15);
}

/* Show the snackbar when clicking on a button (class added with JavaScript) */
#snackbar.show {
  visibility: visible; /* Show the snackbar */
  /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
  However, delay the fade out process for 2.5 seconds */
  -webkit-animation: fadein 0.5s;
  animation: fadein 0.5s;
}

#snackbar.hide {
    webkit-animation: fadeout 0.5s 0.5s;
    animation: fadeout  0.5s 0.5s;
}

#snackbar img {
  width: 100%
}

/* Animations to fade the snackbar in and out */
@-webkit-keyframes fadein {
  from {opacity: 0;}
  to {opacity: 1;}
}

@keyframes fadein {
  from {opacity: 0;}
  to {opacity: 1;}
}

@-webkit-keyframes fadeout {
  from {opacity: 1;}
  to {opacity: 0;}
}

@keyframes fadeout {
  from {opacity: 1;}
  to {opacity: 0;}
}

.notificationtext {
    font-size: 24px;
    display: block;
    bottom: 20px;
}

.topleft {
    top: 20%;
    max-width: 420px;
}

.ttstext {
    position: absolute;
    width: 500px;
    left: 0px;
    top: 310px;
    padding: 10px;
}
</style>